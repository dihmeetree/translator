<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twitch Translator</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0e0e10;
    --surface:#18181b;
    --panel:#1f1f23;
    --border:#2f2f35;
    --text:#efeff1;
    --text-dim:#adadb8;
    --text-muted:#848494;
    --accent:#9147ff;
    --accent-hover:#772ce8;
    --green:#00e676;
    --red:#f44336;
    --yellow:#ffd600;
    --cyan:#00bcd4;
    --magenta:#e040fb;
    --radius:6px;
  }
  html,body{
    height:100%;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    font-size:20px;
    line-height:1.6;
    overflow:hidden;
  }
  /* ── Layout ─────────────────────────────── */
  .app{
    display:flex;
    flex-direction:column;
    height:100dvh;
  }
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:8px 16px;
    background:var(--surface);
    border-bottom:1px solid var(--border);
    flex-shrink:0;
    min-height:42px;
  }
  .header-left{display:flex;align-items:center;gap:10px}
  .logo{font-size:20px;font-weight:700;color:var(--accent)}
  .channel-name{font-size:16px;color:var(--text-dim)}
  .status{display:flex;align-items:center;gap:6px;font-size:16px;color:var(--text-muted)}
  .status-dot{
    width:8px;height:8px;border-radius:50%;
  }
  .status-dot.connected{background:var(--green)}
  .status-dot.disconnected{background:var(--red)}
  .status-dot.connecting{background:var(--yellow)}

  .channel-bar{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 16px;
    background:var(--bg);
    border-bottom:1px solid var(--border);
    flex-shrink:0;
  }
  .channel-bar label{
    font-size:14px;
    color:var(--text-muted);
    white-space:nowrap;
  }
  .channel-bar input{
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:4px;
    color:var(--text);
    font-size:18px;
    padding:8px 12px;
    flex:1;
    min-width:0;
    outline:none;
  }
  .channel-bar input::placeholder{text-transform:capitalize}
  .channel-bar input:focus{border-color:var(--accent)}
  .channel-bar button{
    background:var(--accent);
    color:#fff;
    border:none;
    border-radius:4px;
    padding:8px 16px;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
  }
  .channel-bar button:hover{background:var(--accent-hover)}
  .channel-bar button:disabled{opacity:.5;cursor:not-allowed}

  .main{
    display:grid;
    grid-template-columns:1fr 1fr;
    flex:1;
    overflow:hidden;
    min-height:0;
  }

  /* ── Panel (shared) ─────────────────────── */
  .panel{
    display:flex;
    flex-direction:column;
    background:var(--panel);
    overflow:hidden;
    position:relative;
  }
  .panel + .panel{
    border-left:1px solid var(--border);
  }
  .panel-body{
    flex:1;
    overflow-y:auto;
    display:flex;
    flex-direction:column-reverse;
    padding:8px;
    min-height:0;
    position:relative;
    contain:layout style;
    will-change:scroll-position;
  }
  .panel-body::-webkit-scrollbar{width:6px}
  .panel-body::-webkit-scrollbar-track{background:transparent}
  .panel-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  .panel-body::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}


  /* ── Chat Message ───────────────────────── */
  .msg{
    padding:16px;
    margin:8px;
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:8px;
    line-height:1.3;
    contain:content;
    content-visibility:auto;
    contain-intrinsic-size:auto 80px;
  }
  .msg:hover{background:#1e1e24;border-color:#3a3a44}

  .msg-reply{
    font-size:16px;
    color:var(--text-muted);
    margin-bottom:6px;
    padding:4px 8px;
    background:rgba(255,255,255,.03);
    border-radius:4px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .msg-reply .reply-name{color:var(--cyan)}

  .msg-line{word-wrap:break-word}
  .badge{
    display:inline-block;
    font-size:13px;
    font-weight:700;
    padding:2px 5px;
    border-radius:3px;
    margin-right:4px;
    vertical-align:middle;
    line-height:1.4;
    color:#fff;
  }
  .badge-broadcaster{background:#f44336}
  .badge-mod{background:#00ad03}
  .badge-vip{background:#e005b9}
  .username{font-weight:700;cursor:default}

  .msg-translation{
    margin-top:6px;
    padding:8px 12px;
    font-size:18px;
    background:rgba(145,71,255,.08);
    border-left:3px solid var(--accent);
    border-radius:0 6px 6px 0;
  }
  .romanization{color:var(--text-dim)}
  .translation{color:var(--green)}
  .icon{
    display:inline-block;
    width:16px;height:16px;
    vertical-align:-2px;
    margin-right:4px;
    -webkit-mask-size:contain;
    mask-size:contain;
    -webkit-mask-repeat:no-repeat;
    mask-repeat:no-repeat;
    -webkit-mask-position:center;
    mask-position:center;
    background-color:currentColor;
  }
  .icon-music{
    -webkit-mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 18V5l12-2v13'/%3E%3Ccircle cx='6' cy='18' r='3'/%3E%3Ccircle cx='18' cy='16' r='3'/%3E%3C/svg%3E");
    mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 18V5l12-2v13'/%3E%3Ccircle cx='6' cy='18' r='3'/%3E%3Ccircle cx='18' cy='16' r='3'/%3E%3C/svg%3E");
  }
  .icon-globe{
    -webkit-mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20'/%3E%3Cpath d='M2 12h20'/%3E%3C/svg%3E");
    mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20'/%3E%3Cpath d='M2 12h20'/%3E%3C/svg%3E");
  }

  /* ── Transcription Entry ────────────────── */
  .stt{
    padding:16px;
    margin:8px;
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:8px;
    line-height:1.3;
    contain:content;
    content-visibility:auto;
    contain-intrinsic-size:auto 80px;
  }
  .stt:hover{background:#1e1e24;border-color:#3a3a44}
  .stt-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .stt-time{font-size:16px;color:var(--text-muted)}
  .stt-text{color:var(--text);word-wrap:break-word}
  .stt-translation{
    margin-top:6px;
    padding:8px 12px;
    font-size:18px;
    background:rgba(145,71,255,.08);
    border-left:3px solid var(--accent);
    border-radius:0 6px 6px 0;
  }

  /* ── Empty state ────────────────────────── */
  .empty-state{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    position:absolute;
    inset:0;
    color:var(--text-muted);
    text-align:center;
    padding:20px;
    gap:8px;
  }
  .empty-state .spinner{
    width:24px;height:24px;
    border:2px solid var(--border);
    border-top-color:var(--accent);
    border-radius:50%;
    animation:spin .8s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ── Mobile Tabs ────────────────────────── */
  .tab-bar{
    display:none;
    border-bottom:1px solid var(--border);
    background:var(--surface);
    flex-shrink:0;
  }
  .tab-bar button{
    flex:1;
    padding:10px;
    font-size:16px;
    font-weight:600;
    background:none;
    border:none;
    color:var(--text-muted);
    cursor:pointer;
    border-bottom:2px solid transparent;
  }
  .tab-bar button.active{
    color:var(--text);
    border-bottom-color:var(--text);
  }

  /* ── Responsive ─────────────────────────── */
  @media(max-width:768px){
    .main{
      grid-template-columns:1fr;
      grid-template-rows:1fr;
    }
    .panel.chat-panel{grid-row:1;grid-column:1}
    .panel.stt-panel{grid-row:1;grid-column:1}
    .panel + .panel{border-left:none}
    .tab-bar{display:flex}
    .panel.hidden-mobile{display:none}
  }
  @media(max-width:480px){
    .header{padding:6px 10px}
    .channel-bar{padding:6px 10px}
    .logo{font-size:14px}
    .channel-bar label{display:none}
    .msg{padding:10px}
    .stt{padding:10px}
  }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <span class="logo">Twitch Translator</span>
      <span class="channel-name" id="channelName"></span>
    </div>
    <div class="status">
      <div class="status-dot connecting" id="statusDot"></div>
    </div>
  </div>

  <!-- Channel switch bar -->
  <form class="channel-bar" id="channelForm" autocomplete="off" action="javascript:void(0)">
    <label>Switch channel:</label>
    <input type="text" id="channelInput" placeholder="e.g. xqc"
           maxlength="25" spellcheck="false" autocomplete="off" autocorrect="off"
           autocapitalize="off" enterkeyhint="go">
    <button type="submit" id="channelBtn">Go</button>
  </form>

  <!-- Mobile tab bar -->
  <div class="tab-bar" id="tabBar">
    <button class="active" data-tab="chat">Chat</button>
    <button data-tab="stt">Audio</button>
  </div>

  <!-- Main content -->
  <div class="main">
    <!-- Chat Panel -->
    <div class="panel chat-panel" id="chatPanel">
      <div class="panel-body" id="chatBody">
        <div class="empty-state" id="chatEmpty">
          <div class="spinner"></div>
          <span>Waiting for messages...</span>
        </div>
      </div>
    </div>

    <!-- Transcription Panel -->
    <div class="panel stt-panel hidden-mobile" id="sttPanel">
      <div class="panel-body" id="sttBody">
        <div class="empty-state" id="sttEmpty">
          <div class="spinner"></div>
          <span>Waiting for audio...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ── Config ───────────────────────────────
  const MAX_MESSAGES = 100;
  const RECONNECT_MIN = 1000;
  const RECONNECT_MAX = 30000;
  const RENDER_BATCH_MS = 16; // ~1 frame at 60fps

  // ── State ────────────────────────────────
  let ws = null;
  let reconnectDelay = RECONNECT_MIN;
  let reconnectTimer = null;
  let chatEmptyVisible = true;
  let sttEmptyVisible = true;
  let chatChildCount = 0;
  let sttChildCount = 0;

  // ── DOM refs (cached once) ───────────────
  const statusDot = document.getElementById('statusDot');
  const channelNameEl = document.getElementById('channelName');
  const chatBody = document.getElementById('chatBody');
  const sttBody = document.getElementById('sttBody');
  const tabBar = document.getElementById('tabBar');
  const chatPanel = document.getElementById('chatPanel');
  const sttPanel = document.getElementById('sttPanel');
  const channelInput = document.getElementById('channelInput');
  const channelBtn = document.getElementById('channelBtn');

  // ── HTML escape via regex (avoids DOM element creation per call) ──
  const ESC_MAP = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
  const ESC_RE = /[&<>"']/g;
  function esc(s){
    return s.replace(ESC_RE, function(c){ return ESC_MAP[c]; });
  }

  // ── Color generation with LRU cache ──────
  const COLOR_PALETTE = [
    '#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff',
    '#ff7f00','#7fff00','#ff007f','#007fff','#7f00ff','#ff7f7f'
  ];
  const colorCache = new Map();
  const COLOR_CACHE_MAX = 512;
  function generateColor(name){
    let c = colorCache.get(name);
    if(c !== undefined) return c;
    let h = 0;
    for(let i = 0; i < name.length; i++) h = name.charCodeAt(i) + ((h << 5) - h);
    c = COLOR_PALETTE[Math.abs(h) % COLOR_PALETTE.length];
    if(colorCache.size >= COLOR_CACHE_MAX){
      // Evict oldest entry
      colorCache.delete(colorCache.keys().next().value);
    }
    colorCache.set(name, c);
    return c;
  }

  // ── Time formatter (reuse Intl object) ───
  const timeFmt = new Intl.DateTimeFormat([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

  // ── Fetch config and init ────────────────
  fetch('/api/config')
    .then(function(r){ return r.json(); })
    .then(function(cfg){
      if(cfg.channel) channelNameEl.textContent = '#' + cfg.channel;
    })
    .catch(function(){});

  // ── Mobile tabs ──────────────────────────
  tabBar.addEventListener('click', function(e){
    var btn = e.target.closest('button[data-tab]');
    if(!btn) return;
    var tab = btn.dataset.tab;
    tabBar.querySelectorAll('button').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    if(tab === 'chat'){
      chatPanel.classList.remove('hidden-mobile');
      sttPanel.classList.add('hidden-mobile');
    } else {
      sttPanel.classList.remove('hidden-mobile');
      chatPanel.classList.add('hidden-mobile');
    }
  });

  // ── Channel switching ──────────────────
  function switchChannel(){
    var ch = channelInput.value.trim().toLowerCase();
    if(!ch || !/^[a-z0-9_]{1,25}$/.test(ch)) return;
    channelBtn.disabled = true;
    // Optimistic UI: update immediately so the user sees instant feedback
    // instead of waiting for the backend IRC PART/JOIN round-trip.
    channelNameEl.textContent = '#' + ch;
    clearPanels();
    channelInput.value = '';
    fetch('/api/channel', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({channel:ch})
    })
    .then(function(r){
      if(!r.ok) throw new Error('Failed');
    })
    .catch(function(){})
    .finally(function(){
      channelBtn.disabled = false;
    });
  }

  document.getElementById('channelForm').addEventListener('submit', function(e){
    e.preventDefault();
    switchChannel();
  });

  // ── Empty-state creation helper ──────────
  function makeEmptyState(id, text){
    var el = document.createElement('div');
    el.className = 'empty-state';
    el.id = id;
    el.innerHTML = '<div class="spinner"></div><span>' + text + '</span>';
    return el;
  }

  function clearPanels(){
    // replaceChildren() is faster than removing one-by-one
    chatBody.replaceChildren(makeEmptyState('chatEmpty', 'Waiting for messages...'));
    sttBody.replaceChildren(makeEmptyState('sttEmpty', 'Waiting for audio...'));
    chatEmptyVisible = true;
    sttEmptyVisible = true;
    chatChildCount = 1;
    sttChildCount = 1;
    chatBuffer.length = 0;
    sttBuffer.length = 0;
    chatRafQueue.length = 0;
    sttRafQueue.length = 0;
    chatRafScheduled = false;
    sttRafScheduled = false;
  }

  // ── Buffered insert: hold messages while scrolled up ──
  var chatBuffer = [];
  var sttBuffer = [];

  // ── Scroll detection with cached state ───
  // column-reverse: scrollTop is 0 (or small negative) when at bottom
  var chatAtBottom = true;
  var sttAtBottom = true;

  function checkAtBottom(el){
    return Math.abs(el.scrollTop) < 5;
  }

  chatBody.addEventListener('scroll', function(){
    chatAtBottom = checkAtBottom(chatBody);
    if(chatAtBottom && chatBuffer.length) flushBuffer(chatBody, chatBuffer, true);
  }, {passive:true});

  sttBody.addEventListener('scroll', function(){
    sttAtBottom = checkAtBottom(sttBody);
    if(sttAtBottom && sttBuffer.length) flushBuffer(sttBody, sttBuffer, false);
  }, {passive:true});

  // ── Cap oldest messages using tracked count ──
  function capChildren(parent, isChat){
    // Use tracked count instead of querying parent.children.length
    var count = isChat ? chatChildCount : sttChildCount;
    while(count > MAX_MESSAGES){
      parent.removeChild(parent.lastChild);
      count--;
    }
    if(isChat) chatChildCount = count;
    else sttChildCount = count;
  }

  // ── Flush buffer using DocumentFragment ──
  function flushBuffer(container, buffer, isChat){
    if(!buffer.length) return;
    // Prepend all buffered elements at once via fragment
    var frag = document.createDocumentFragment();
    for(var i = 0; i < buffer.length; i++){
      frag.appendChild(buffer[i]);
    }
    if(isChat) chatChildCount += buffer.length;
    else sttChildCount += buffer.length;
    buffer.length = 0;
    container.prepend(frag);
    capChildren(container, isChat);
  }

  // ── RAF batching: coalesce rapid WS messages into single frame ──
  var chatRafQueue = [];
  var sttRafQueue = [];
  var chatRafScheduled = false;
  var sttRafScheduled = false;

  function scheduleChatFlush(){
    if(chatRafScheduled) return;
    chatRafScheduled = true;
    requestAnimationFrame(flushChatRaf);
  }

  function scheduleSttFlush(){
    if(sttRafScheduled) return;
    sttRafScheduled = true;
    requestAnimationFrame(flushSttRaf);
  }

  function flushChatRaf(){
    chatRafScheduled = false;
    if(!chatRafQueue.length) return;
    // Remove empty-state on first real message
    if(chatEmptyVisible){
      var ce = document.getElementById('chatEmpty');
      if(ce) ce.remove();
      chatEmptyVisible = false;
      chatChildCount--;
    }
    if(chatAtBottom){
      // Batch all queued elements into a single DOM operation
      var frag = document.createDocumentFragment();
      for(var i = 0; i < chatRafQueue.length; i++){
        frag.appendChild(chatRafQueue[i]);
      }
      chatChildCount += chatRafQueue.length;
      chatRafQueue.length = 0;
      chatBody.prepend(frag);
      capChildren(chatBody, true);
    } else {
      // Push to scroll-locked buffer
      for(var j = 0; j < chatRafQueue.length; j++){
        chatBuffer.push(chatRafQueue[j]);
      }
      chatRafQueue.length = 0;
    }
  }

  function flushSttRaf(){
    sttRafScheduled = false;
    if(!sttRafQueue.length) return;
    if(sttEmptyVisible){
      var se = document.getElementById('sttEmpty');
      if(se) se.remove();
      sttEmptyVisible = false;
      sttChildCount--;
    }
    if(sttAtBottom){
      var frag = document.createDocumentFragment();
      for(var i = 0; i < sttRafQueue.length; i++){
        frag.appendChild(sttRafQueue[i]);
      }
      sttChildCount += sttRafQueue.length;
      sttRafQueue.length = 0;
      sttBody.prepend(frag);
      capChildren(sttBody, false);
    } else {
      for(var j = 0; j < sttRafQueue.length; j++){
        sttBuffer.push(sttRafQueue[j]);
      }
      sttRafQueue.length = 0;
    }
  }

  // ── Build translation block HTML (shared by chat + stt) ──
  function buildTranslationHtml(msg, cssClass){
    var html = '<div class="' + cssClass + '">';
    if(msg.romanization){
      html += '<div class="romanization"><span class="icon icon-music"></span>' + esc(msg.romanization) + '</div>';
    }
    html += '<div class="translation"><span class="icon icon-globe"></span>' + esc(msg.translation) + '</div></div>';
    return html;
  }

  // ── Render chat message ──────────────────
  function renderChat(msg){
    var div = document.createElement('div');
    div.className = 'msg';

    var html = '';

    // Reply context
    if(msg.reply_to){
      html += '<div class="msg-reply">replying to <span class="reply-name">@'
        + esc(msg.reply_to.parent_username) + '</span>: '
        + esc(truncate(msg.reply_to.parent_message, 60)) + '</div>';
    }

    // Main line: badges + username + message
    html += '<div class="msg-line">';
    if(msg.is_broadcaster) html += '<span class="badge badge-broadcaster">B</span>';
    else if(msg.is_mod) html += '<span class="badge badge-mod">M</span>';
    else if(msg.is_vip) html += '<span class="badge badge-vip">V</span>';

    var color = msg.color || generateColor(msg.username);
    html += '<span class="username" style="color:' + esc(color) + '">'
      + esc(msg.username) + '</span>: '
      + esc(msg.content) + '</div>';

    // Translation block
    if(msg.translation) html += buildTranslationHtml(msg, 'msg-translation');

    div.innerHTML = html;
    chatRafQueue.push(div);
    scheduleChatFlush();
  }

  // ── Render transcription ─────────────────
  function renderStt(msg){
    if(!msg.translation) return;

    var div = document.createElement('div');
    div.className = 'stt';

    var time = timeFmt.format(new Date(msg.timestamp));

    var html = '<div class="stt-header">'
      + '<span class="stt-time">' + esc(time) + '</span>'
      + '</div>';
    html += '<div class="stt-text">' + esc(msg.transcript) + '</div>';

    if(msg.translation) html += buildTranslationHtml(msg, 'stt-translation');

    div.innerHTML = html;
    sttRafQueue.push(div);
    scheduleSttFlush();
  }

  // ── Helpers ──────────────────────────────
  function truncate(s, max){
    return s.length > max ? s.slice(0, max) + '...' : s;
  }

  // ── WebSocket connection ─────────────────
  function setStatus(state){
    statusDot.className = 'status-dot ' + state;
  }

  function connect(){
    if(ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
    setStatus('connecting');

    var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws');

    ws.onopen = function(){
      setStatus('connected');
      reconnectDelay = RECONNECT_MIN;
    };

    ws.onclose = function(){
      setStatus('disconnected');
      scheduleReconnect();
    };

    ws.onerror = function(){};

    ws.onmessage = function(e){
      try {
        var event = JSON.parse(e.data);
        switch(event.type){
          case 'ChatMessage': renderChat(event); break;
          case 'Transcription': renderStt(event); break;
          case 'ChannelChanged':
            channelNameEl.textContent = '#' + event.channel;
            clearPanels();
            break;
        }
      } catch(err){}
    };
  }

  function scheduleReconnect(){
    if(reconnectTimer) return;
    setStatus('connecting');
    reconnectTimer = setTimeout(function(){
      reconnectTimer = null;
      connect();
    }, reconnectDelay);
    reconnectDelay = Math.min(reconnectDelay * 2, RECONNECT_MAX);
  }

  // ── Start ────────────────────────────────
  connect();
})();
</script>
</body>
</html>
